# Qwen3-Coder-30B Optimized for 24GB VRAM (RTX 4090)
# Using Unsloth Dynamic Q4_K_XL Quantization
# Base: danielsheep/Qwen3-Coder-30B-A3B-Instruct-1M-Unsloth:UD-Q4_K_XL

FROM danielsheep/Qwen3-Coder-30B-A3B-Instruct-1M-Unsloth:UD-Q4_K_XL

# Template for Qwen3-Coder with tool support
TEMPLATE """{{- if .System }}<|im_start|>system
{{ .System }}{{ if .Tools }}

You have access to the following tools:
{{ json .Tools }}<|im_end|>{{ else }}<|im_end|>{{ end }}
{{ end }}{{- range .Messages }}{{- if eq .Role "user" }}<|im_start|>user
{{ .Content }}<|im_end|>
{{ else if eq .Role "assistant" }}<|im_start|>assistant
{{- if .Content }}{{ .Content }}{{ end }}{{- if .ToolCalls }}
<tool_call>
{{- range .ToolCalls }}
{"name": "{{ .Function.Name }}", "arguments": {{ json .Function.Arguments }}}
{{- end }}
</tool_call>{{ end }}<|im_end|>
{{ else if eq .Role "tool" }}<|im_start|>tool
{{ .Content }}<|im_end|>
{{ end }}{{- end }}{{- if .Prompt }}<|im_start|>user
{{ .Prompt }}<|im_end|>
{{ end }}<|im_start|>assistant
"""

# Comprehensive system prompt for expert coding with 1M context awareness
SYSTEM """You are Qwen3-Coder, an advanced AI coding assistant with deep expertise across all programming languages and frameworks. You have access to an extended context window allowing you to understand entire codebases.

Key capabilities:
- Agentic coding with tool-calling support
- Repository-scale understanding with up to 1M token context
- Advanced reasoning for complex algorithms and architecture
- Multi-file refactoring and dependency analysis
- Security-conscious and performance-optimized implementations
- Context-aware suggestions based on the entire codebase
Always consider the broader project context and maintain consistency with existing code patterns."""

# Parameters optimized for quality and context understanding
PARAMETER temperature 0.7
PARAMETER top_p 0.8
PARAMETER top_k 20
PARAMETER repeat_penalty 1.05
PARAMETER repeat_last_n 256
PARAMETER num_predict 8192
PARAMETER num_ctx 8192

PARAMETER stop "<|im_start|>"
PARAMETER stop "<|im_end|>"
PARAMETER stop "<|endoftext|>"
PARAMETER stop "</tool_call>"
PARAMETER seed 0