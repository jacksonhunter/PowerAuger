graph TD
    subgraph "User Interface (PSReadLine)"
        UserInput[User types in PowerShell] -->|Triggers Prediction| GetCmdPrediction
    end

    subgraph "PowerAuger Core Engine"
        GetCmdPrediction("Get-CommandPrediction (Orchestrator)")
        GetContext("1. Get-EnhancedContext")
        SelectModel("2. Select-OptimalModel")
        GetCache("3. Get-CachedPrediction")

        UserInput --> GetCmdPrediction
        GetCmdPrediction --> GetContext
        GetContext --> SelectModel
        GetCmdPrediction --> SelectModel
        SelectModel --> GetCache
    end

    subgraph "Data & State Management"
        Config["$global:OllamaConfig (Loaded from $PROFILE)"]
        Cache["$global:PredictionCache"]
        History["$global:CommandHistory & RecentTargets"]
        
        GetContext -- "Reads from" --> History
        GetCache -- "Reads/Writes" --> Cache
        SelectModel -- "Reads" --> Config
        InvokeOllama -- "Reads" --> Config
    end

    subgraph "Prediction Path"
        style InvokeOllama fill:#d4edda,stroke:#155724
        style HistoryFallback fill:#fff3cd,stroke:#856404
        
        InvokeOllama("Invoke-OllamaCompletion")
        HistoryFallback("Get-HistoryBasedSuggestions (Fallback)")

        GetCache -- "Cache Miss 👎" --> InvokeOllama
        GetCache -- "Cache Hit 👍" --> ReturnResult[Return Cached Suggestions]
        
        InvokeOllama -- "API Call Fails ❌" --> HistoryFallback
        InvokeOllama -- "API Call Succeeds ✅" --> ParseResponse("Parse Model Response")
        
        ParseResponse --> ReturnResult2[Return AI Suggestions]
        HistoryFallback --> ReturnResult3[Return History Suggestions]
    end

    subgraph "External Communication"
        style OllamaAPI fill:#f8d7da,stroke:#721c24
        BuildPrompt("Build-ContextualPrompt")
        TestConnection("Test-OllamaConnection")
        SSHTunnel["SSH Tunnel Process"]
        OllamaAPI["Remote Ollama API"]

        InvokeOllama --> BuildPrompt
        BuildPrompt --> TestConnection
        TestConnection -- "Ensures Active" --> SSHTunnel
        SSHTunnel -- "Forwards Traffic" --> OllamaAPI
    end
    
    subgraph "Background Feedback Loop"
        OnIdleEvent("PowerShell.OnIdle Event")
        AddHistory("Add-CommandToHistory")
        UpdateTargets("Update-RecentTargets")
        
        OnIdleEvent -- "Captures last command" --> AddHistory
        AddHistory -- "Extracts paths" --> UpdateTargets
        UpdateTargets -- "Updates" --> History
    end

    ReturnResult --> Display
    ReturnResult2 --> Display
    ReturnResult3 --> Display
    Display[Display Suggestions in Terminal]

